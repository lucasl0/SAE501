{% extends "layouts/back-end/base.njk" %}
{% block title %}Auteur - {{ author.firstname }} {{ author.lastname }}{% endblock %}

{% block title %}
    {% if is_edit %}
        Éditer "{{ author.firstname }} {{ author.lastname }}"
    {% else %}
        Ajouter un auteur
    {% endif %}
{% endblock %}

{% set chars_limit = 300 %}
{% set active_menu_item = "auteurs" %}

{% import "components/back-end/input-file.njk" as input_file with context %}

{% block main %}
    <div class="bg-white rounded-2xl shadow-md pb-6">
        <header class="mb-1 p-6">
            {% include "components/back-end/breadcrumb.njk" %}
            <h2 class="text-4xl">
                {% if is_edit %}
                    Éditer "{{ author.firstname }} {{ author.lastname }}"
                {% else %}
                    Ajouter un auteur
                {% endif %}
            </h2>
            <p class="text-sm">
                Les champs avec
                <span class="font-bold text-slate-700 after:content-['*'] after:ml-0.5 after:text-red-500"></span>
                sont requis
            </p>
        </header>

        <div class="px-6">
            {% for item in list_errors %}
                <p class="rounded-lg p-3 bg-red-100 text-red-800 border border-red-700 mb-3">{{ item }}</p>
            {% endfor %}

            <p id="form_error_front" class="hidden rounded-lg p-3 bg-red-100 text-red-800 border border-red-700 mb-3">
                Merci de vérifier les champs (email valide + champs obligatoires).
            </p>

            <form action="" method="post" enctype="multipart/form-data" data-form novalidate>

                <div class="grid gap-4 md:grid-cols-2">
                    <label class="block">
                        <span class="font-bold text-slate-700 after:content-['*'] after:ml-0.5 after:text-red-500">Nom</span>
                        <input
                            class="block bg-white w-full border border-slate-300 rounded-md py-2 pr-3 shadow-xs focus:outline-hidden focus:border-sky-500 focus:ring-sky-500 focus:ring-1 sm:text-sm"
                            type="text"
                            name="lastname"
                            value="{{ author.lastname }}"
                            required
                        />
                    </label>

                    <label class="block">
                        <span class="font-bold text-slate-700 after:content-['*'] after:ml-0.5 after:text-red-500">Prénom</span>
                        <input
                            class="block bg-white w-full border border-slate-300 rounded-md py-2 pr-3 shadow-xs focus:outline-hidden focus:border-sky-500 focus:ring-sky-500 focus:ring-1 sm:text-sm"
                            type="text"
                            name="firstname"
                            value="{{ author.firstname }}"
                            required
                        />
                    </label>

                    <label class="block md:col-span-2">
                        <span class="font-bold text-slate-700 after:content-['*'] after:ml-0.5 after:text-red-500">Email</span>
                        <input
                            class="block bg-white w-full border border-slate-300 rounded-md py-2 pr-3 shadow-xs focus:outline-hidden focus:border-sky-500 focus:ring-sky-500 focus:ring-1 sm:text-sm"
                            type="email"
                            name="email"
                            value="{{ author.email }}"
                            required
                        />
                    </label>
                </div>

                <div class="block mb-4 mt-4">
                    <label>
                        <span class="font-bold text-slate-700 after:content-['*'] after:ml-0.5 after:text-red-500">Image</span>
                    </label>

                    {{ input_file.field(author.image, "image", ".jpg, .jpeg, .png, .avif") }}
                </div>

                <label class="block mb-4">
                    <span class="font-bold text-slate-700">Bio</span>
                    <textarea
                        name="bio"
                        rows="5"
                        maxlength="{{ chars_limit }}"
                        data-maxlength="{{ chars_limit }}"
                        class="block bg-white w-full border border-slate-300 rounded-md py-2 pr-3 shadow-xs focus:outline-hidden focus:border-sky-500 focus:ring-sky-500 focus:ring-1 sm:text-sm"
                        aria-describedby="bio_counter"
                    >{{ author.bio }}</textarea>

                    <p class="text-sm text-slate-600" id="bio_counter">
                        {{ chars_limit }} caractères restants
                    </p>
                </label>

                <div class="flex gap-x-3 gap-y-5 flex-col justify-end sm:flex-row">
                    <button class="px-4 py-2 font-semibold text-sm bg-blue-700 hocus:bg-blue-950 text-white rounded-2xl shadow-xs" type="submit">
                        Sauvegarder
                    </button>
                    <button class="px-4 py-2 font-semibold text-sm bg-neutral-100 hocus:bg-neutral-200 text-black rounded-2xl shadow-xs" type="reset">
                        Réinitialiser
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("form[data-form]");
            const errorFront = document.getElementById("form_error_front");

            const bio = document.querySelector('textarea[name="bio"]');
            const counter = document.getElementById("bio_counter");

            if (bio && counter) {
                const maxLength = parseInt(bio.dataset.maxlength, 10);
                const updateCounter = () => {
                    const remaining = maxLength - bio.value.length;
                    counter.textContent = `${remaining} caractères restants`;
                };
                updateCounter();
                bio.addEventListener("input", updateCounter);
            }

            if (form) {
                form.addEventListener("submit", (e) => {
                    if (errorFront) errorFront.classList.add("hidden");

                    const required = form.querySelectorAll("[required]");
                    let ok = true;

                    required.forEach((el) => {
                        el.classList.remove("border-red-500");
                        if (!el.checkValidity()) {
                            ok = false;
                            el.classList.add("border-red-500");
                        }
                    });

                    if (!ok) {
                        e.preventDefault();
                        if (errorFront) errorFront.classList.remove("hidden");
                    }
                });
            }
        });
    </script>
{% endblock %}
