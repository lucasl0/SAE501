{% extends "layouts/back-end/base.njk" %}

{% block title %}
    {% if is_edit == true %}
        Editer "{{ sae.title }}"
    {% else %}
        Créer SAÉ
    {% endif %}
{% endblock %}

{% set chars_limit = 200 %}
{% set active_menu_item = "saes" %}

{% import "components/back-end/input-file.njk" as input_file with context %}

{% block main %}
<div class="bg-white rounded-2xl shadow-md pb-6">
    <header class="mb-1 p-6">
        {% include "components/back-end/breadcrumb.njk" %}
        <h2 class="text-4xl">
            {% if is_edit == true %}
                Editer "{{ sae.title }}"
            {% else %}
                Créer SAÉ
            {% endif %}
        </h2>
        <p class="text-sm">
            Les champs avec
            <span class="font-bold text-slate-700 after:content-['*'] after:ml-0.5 after:text-red-500"></span>
            sont requis
        </p>
    </header>

    <div class="px-6">
        {% for item in list_errors %}
            <p class="rounded-lg p-3 bg-red-100 text-red-800 border border-red-700 mb-3">
                {{ item }}
            </p>
        {% endfor %}

        {% if messages.success %}
            <p class="rounded-lg p-3 bg-green-100 text-green-800 border border-green-700 mb-3" data-flash-message>
                {{ messages.success }}
            </p>
        {% endif %}

        <form action="" method="post" enctype="multipart/form-data">

            <!-- TITRE -->
            <label class="block mb-4">
                <span class="font-bold text-slate-700 after:content-['*'] after:ml-0.5 after:text-red-500">
                    Titre
                </span>
                <input
                    class="block bg-white w-full border border-slate-300 rounded-md py-2 pr-3 shadow-xs focus:outline-hidden focus:border-sky-500 focus:ring-sky-500 focus:ring-1 sm:text-sm"
                    type="text"
                    name="title"
                    value="{{ sae.title }}"
                />
            </label>

            <!-- IMAGE -->
            <div class="block mb-4">
                <label>
                    <span class="font-bold text-slate-700">Image</span>
                </label>
                {{ input_file.field(sae.image, undefined, ".jpg, .jpeg, .png, .avif") }}
            </div>

            <!-- CONTENU + COMPTEUR -->
            <label class="block mb-4">
                <div class="flex items-center justify-between gap-3">
                    <span class="font-bold text-slate-700">Contenu</span>
                    <span
                        id="counter_description"
                        class="text-sm text-slate-500"
                        aria-live="polite"
                    >
                        {{ chars_limit }} caractères restants
                    </span>
                </div>

                <textarea
                    name="content"
                    rows="5"
                    maxlength="{{ chars_limit }}"
                    data-maxlength="{{ chars_limit }}"
                    class="mt-2 block bg-white w-full border border-slate-300 rounded-md py-2 pr-3 shadow-xs focus:outline-hidden focus:border-sky-500 focus:ring-sky-500 focus:ring-1 sm:text-sm"
                    aria-describedby="counter_description"
                >{{ sae.content }}</textarea>
            </label>

            <!-- BOUTONS -->
            <div class="flex gap-x-3 gap-y-5 flex-col justify-end sm:flex-row">
                <button
                    class="px-4 py-2 font-semibold text-sm bg-blue-700 hocus:bg-blue-950 text-white rounded-2xl shadow-xs inline-flex gap-1 items-center justify-center"
                    type="submit"
                >
                    Sauvegarder
                </button>

                <button
                    class="px-4 py-2 font-semibold text-sm bg-neutral-100 hocus:bg-neutral-200 text-black rounded-2xl shadow-xs"
                    type="reset"
                >
                    Réinitialiser
                </button>
            </div>

        </form>
    </div>
</div>

<!-- SCRIPT COMPTEUR -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const textarea = document.querySelector('textarea[name="content"]');
    const counter = document.getElementById("counter_description");

    if (!textarea || !counter) return;

    const maxLength = Number(textarea.dataset.maxlength || textarea.maxLength || 0);

    const updateCounter = () => {
        const used = textarea.value.length;
        const remaining = Math.max(0, maxLength - used);
        counter.textContent = `${remaining} caractères restants`;
    };

    // Initialisation (important en édition)
    updateCounter();

    textarea.addEventListener("input", updateCounter);
});
</script>

{% endblock %}
